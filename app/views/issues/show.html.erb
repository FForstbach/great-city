
<div class="container">
  <div class="row">
    <div class="col-xs-12 col-sm-offset-4 col-sm-4">
      <p id="notice"><%= notice %></p>
      <%= link_to '< Go back to overview', issues_path %>
      <div id="project_detail">
        <div>
          <h1><%= @issue.title.upcase %></h1>
        </div>
        <div>
          <%= image_tag @issue.photo.url(:medium) %>
        </div>
        <div>
          <h4>Description</h4>
          <p><%= !@issue.description.nil? ? @issue.description : "No description" %></p>
          <h4>Address</h4>
          <p id='address'><%= !@issue.address.nil? ? @issue.address : "Unknown address" %></p>
          <h4>Votes</h4>
          <p id='vote-count'><%= !@issue.votes.nil? ? @issue.votes : "0 votes so far" %></p>
        </div>
        <div>
          <p class="button vote" id="issue-<%= @issue.id %>">Vote for this project</p>
          <a href='', id='share-link'>Click to copy link</a>
        </div>
      </div>
      <div id="map" style="width: 100%; height: 230px;"></div>
      <%= link_to 'Back', issues_path %>
      <% if user_signed_in? %>
        | <%= link_to 'Edit', edit_issue_path(@issue) %> |
        <td><%= link_to 'Destroy', issue_path, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      <% end %>
    </div>
  </div>
</div>
<% content_for(:after_js) do %>
  <%= javascript_include_tag "https://cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/markerclusterer/src/markerclusterer_compiled.js" %>
  <script>
  $(document).on('ready', function() {
    var link = document.getElementById("share-link");
    link.addEventListener('click', function(event){
        event.preventDefault();
    }, {passive: false});

    new Clipboard('#share-link', {
        text: function(trigger) {
            alert('Link copied to clipboard!')
            return window.location.href;
        }
    });
  });
  </script>
  <script>
  $(document).on('ready', function() {
    $("p[id*='issue-']").one( "click", function(elem) {
      var id = elem.target.id.replace('issue-','')
      var votes = parseInt($('#vote-count').text()) + 1
      $('#vote-count').text(votes + ' votes so far')
      $.ajax({
        url: '/issues/' + id + '/vote',
        method: 'POST'
      })

    });
  });

  </script>

  <!-- Include Google Maps JS library. You should use your *own* key -->
  <%= javascript_include_tag "https://maps.google.com/maps/api/js?libraries=places&key=#{ENV['GOOGLE_API_BROWSER_KEY']}" %>

  <!-- Include Dependencies of GMaps for Rails gem -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-marker-clusterer/1.0.0/markerclusterer_compiled.js"></script>
  <script src="https://cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js"></script>
  <script src="https://cdn.rawgit.com/apneadiving/Google-Maps-for-Rails/master/js_compilation/gmaps_google.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script>

  <script type="text/javascript">
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
    });
    var geocoder = new google.maps.Geocoder();

    function geocodeAddress(geocoder, resultsMap) {
      var address = document.getElementById('address').innerHTML;
      geocoder.geocode({'address': address}, function(results, status) {
        if (status === 'OK') {
          resultsMap.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
            map: resultsMap,
            position: results[0].geometry.location
          });
        } else {
          console.log('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    $(document).on('ready', function() {
        geocodeAddress(geocoder, map);
    });
  </script>
<% end %>
